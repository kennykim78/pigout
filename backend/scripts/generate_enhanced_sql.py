import json
import re

# JSON íŒŒì¼ ë¡œë“œ
with open('backend/scripts/food-rules-data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

sql_statements = []

# ì˜ì–‘ì†Œ íŒŒì‹± í•¨ìˆ˜
def parse_nutrient(value_str):
    if not value_str: return 0
    # "120kcal", "1.5g", "10mg" ë“±ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
    match = re.search(r'([\d\.]+)', str(value_str))
    if match:
        return float(match.group(1))
    return 0

for food_name, info in data.items():
    warnings = []
    tips = []
    
    nutrients = info.get('nutrients', {})
    disease_analysis = info.get('diseaseAnalysis', {})
    
    # 1. ì˜ì–‘ì†Œ ê¸°ë°˜ ë¶„ì„
    sodium = parse_nutrient(nutrients.get('sodium', '0'))
    sugar = parse_nutrient(nutrients.get('sugar', '0'))
    fat = parse_nutrient(nutrients.get('fat', '0'))
    protein = parse_nutrient(nutrients.get('protein', '0'))
    potassium = parse_nutrient(nutrients.get('potassium', '0'))
    calories = parse_nutrient(nutrients.get('calories', '0'))
    
    # ë‚˜íŠ¸ë¥¨ ê²½ê³ 
    if sodium >= 800:
        warnings.append(f"ë§¤ìš° ë†’ì€ ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰({sodium}mg) - ê³ í˜ˆì••/ì‹ ì¥ì§ˆí™˜ ì£¼ì˜")
        tips.append("êµ­ë¬¼ ì„­ì·¨ë¥¼ ìì œí•˜ê³  ê±´ë”ê¸° ìœ„ì£¼ë¡œ ë“œì„¸ìš”")
        tips.append("ì¹¼ë¥¨ì´ í’ë¶€í•œ ì±„ì†Œ(í† ë§ˆí† , ë°”ë‚˜ë‚˜ ë“±)ì™€ í•¨ê»˜ ë“œì‹œë©´ ë‚˜íŠ¸ë¥¨ ë°°ì¶œì— ë„ì›€ì´ ë©ë‹ˆë‹¤")
    elif sodium >= 400:
        warnings.append(f"ë†’ì€ ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰({sodium}mg) ì£¼ì˜")
        tips.append("ì¡°ë¦¬ ì‹œ ì†Œê¸ˆì´ë‚˜ ê°„ì¥ ì‚¬ìš©ì„ ì¤„ì´ê³  ì²œì—° í–¥ì‹ ë£Œë¥¼ í™œìš©í•˜ì„¸ìš”")

    # ë‹¹ë¥˜ ê²½ê³ 
    if sugar >= 20:
        warnings.append(f"ë§¤ìš° ë†’ì€ ë‹¹ë¥˜ í•¨ëŸ‰({sugar}g) - í˜ˆë‹¹ ê¸‰ìƒìŠ¹ ì£¼ì˜")
        tips.append("ì„­ì·¨ëŸ‰ì„ ì ˆë°˜ìœ¼ë¡œ ì¤„ì´ê±°ë‚˜, ì‹ì‚¬ í›„ ë””ì €íŠ¸ë¡œ ì†ŒëŸ‰ë§Œ ë“œì„¸ìš”")
    elif sugar >= 10:
        warnings.append(f"ë‹¹ë¥˜ í•¨ëŸ‰({sugar}g) ì£¼ì˜")
        tips.append("ê³¼ë‹¤ ì„­ì·¨ ì‹œ ì²´ì¤‘ ì¦ê°€ì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤")

    # ì§€ë°©/í¬í™”ì§€ë°© íŒ
    if fat >= 15:
        warnings.append(f"ë†’ì€ ì§€ë°© í•¨ëŸ‰({fat}g) - ê³ ì§€í˜ˆì¦ ì£¼ì˜")
        tips.append("ê¸°ë¦„ê¸°ë¥¼ ì œê±°í•˜ê±°ë‚˜ íŠ€ê¸°ëŠ” ëŒ€ì‹  êµ½ê±°ë‚˜ ì°ŒëŠ” ì¡°ë¦¬ë²•ì„ ì„ íƒí•˜ì„¸ìš”")
        
    # ì¹¼ë¥¨ íŒ (ì‹ ì¥ì§ˆí™˜ ê´€ë ¨)
    if potassium >= 500:
        warnings.append(f"ê³ ì¹¼ë¥¨ ì‹í’ˆ({potassium}mg) - ì‹ ì¥ì§ˆí™˜ì ì„­ì·¨ ì œí•œ í•„ìš”")
        tips.append("ì‹ ì¥ ê¸°ëŠ¥ì´ ì €í•˜ëœ ê²½ìš°, ë¬¼ì— 2ì‹œê°„ ì´ìƒ ë‹´ê°€ ì¹¼ë¥¨ì„ ëº€ í›„ ì¡°ë¦¬í•˜ì„¸ìš”")
        tips.append("ì±„ì†ŒëŠ” ë°ì³ì„œ ë“œì‹œë©´ ì¹¼ë¥¨ í•¨ëŸ‰ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤")

    # ë‹¨ë°±ì§ˆ íŒ
    if protein >= 15:
        tips.append(f"í›Œë¥­í•œ ë‹¨ë°±ì§ˆ ê³µê¸‰ì›({protein}g)ì…ë‹ˆë‹¤")
        tips.append("ê·¼ìœ¡ ìœ ì§€ì™€ ë©´ì—­ë ¥ ê°•í™”ì— ë„ì›€ì´ ë©ë‹ˆë‹¤")

    # 2. ì§ˆë³‘ ë¶„ì„ ê¸°ë°˜ ê²½ê³  (Risk: warning/caution)
    for disease, analysis in disease_analysis.items():
        risk = analysis.get('risk')
        reason = analysis.get('reason')
        if risk == 'warning':
            warnings.append(f"ğŸš¨ {disease} ìœ„í—˜: {reason}")
        elif risk == 'caution':
            warnings.append(f"âš ï¸ {disease} ì£¼ì˜: {reason}")

    # 3. ì „ë¬¸ê°€ ì¡°ì–¸ (Expert Advice) í™œìš©
    expert_advice = info.get('expertAdvice')
    if expert_advice:
        tips.append(f"ğŸ’¡ ì „ë¬¸ê°€ ì¡°ì–¸: {expert_advice}")

    # 4. ì¥ë‹¨ì (Pros/Cons) í™œìš©
    cons = info.get('cons')
    if cons:
        # ë‹¨ì  í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•´ì„œ ê²½ê³ ì— ì¶”ê°€ (ë„ˆë¬´ ê¸¸ë©´ ìƒëµ)
        cons_list = [c.strip() for c in cons.split(',')]
        for c in cons_list:
            if "ì£¼ì˜" in c or "ìœ„í—˜" in c or "ë¶€ì‘ìš©" in c:
                warnings.append(c)

    # ì¤‘ë³µ ì œê±° ë° ì •ë¦¬
    warnings = list(dict.fromkeys(warnings)) # ìˆœì„œ ìœ ì§€ ì¤‘ë³µ ì œê±°
    tips = list(dict.fromkeys(tips))
    
    # SQL ìƒì„± (ë°°ì—´ í¬ë§·íŒ…)
    # ì‘ì€ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
    warnings_sql = [w.replace("'", "''") for w in warnings]
    tips_sql = [t.replace("'", "''") for t in tips]
    
    warnings_str = ", ".join([f"'{w}'" for w in warnings_sql])
    tips_str = ", ".join([f"'{t}'" for t in tips_sql])
    
    sql = f"UPDATE food_rules SET warnings = ARRAY[{warnings_str}]::text[], cooking_tips = ARRAY[{tips_str}]::text[] WHERE food_name = '{food_name}';"
    sql_statements.append(sql)

# íŒŒì¼ ì €ì¥
with open('backend/migrations/20251217_enhanced_food_rules_update.sql', 'w', encoding='utf-8') as f:
    f.write("-- ========================================\n")
    f.write("-- food_rules ë°ì´í„° ì •ë°€ ì—…ë°ì´íŠ¸ (ì˜ì–‘ì„±ë¶„ ë° ì§ˆë³‘ë¶„ì„ ê¸°ë°˜)\n")
    f.write("-- Generated by VS Code Assistant (Enhanced Logic)\n")
    f.write("-- ========================================\n\n")
    for stmt in sql_statements:
        f.write(stmt + "\n")

print(f"Generated {len(sql_statements)} enhanced SQL statements.")
